<!--pages/history/history.wxml-->
<view class="page">
  <!-- ç­›é€‰æ ‡ç­¾ -->
  <view class="filter-tabs">
    <view 
      class="tab-item {{activeTab === 'all' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="all"
    >
      å…¨éƒ¨
    </view>
    <view 
      class="tab-item {{activeTab === 'confirmed' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="confirmed"
    >
      å·²ç¡®è®¤
    </view>
    <view 
      class="tab-item {{activeTab === 'completed' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="completed"
    >
      å·²å®Œæˆ
    </view>
    <view 
      class="tab-item {{activeTab === 'cancelled' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="cancelled"
    >
      å·²å–æ¶ˆ
    </view>
  </view>

  <!-- é¢„çº¦è®°å½•åˆ—è¡¨ -->
  <view class="booking-list" wx:if="{{filteredBookings.length > 0}}">
    <view 
      class="booking-card"
      wx:for="{{filteredBookings}}" 
      wx:key="id"
    >
      <view class="card-header">
        <view class="booking-status status-{{item.status}}">
          {{getStatusText(item.status)}}
        </view>
        <text class="booking-time">{{formatTime(item.createTime)}}</text>
      </view>
      
      <view class="card-content">
        <view class="court-info">
          <text class="court-name">{{item.courtName}}</text>
          <text class="court-type">æ ‡å‡†åœºåœ°</text>
        </view>
        
        <view class="booking-details">
          <view class="detail-row">
            <text class="detail-label">æ—¥æœŸï¼š</text>
            <text class="detail-value">{{formatDate(item.date)}}</text>
          </view>
          <view class="detail-row">
            <text class="detail-label">æ—¶é—´ï¼š</text>
            <text class="detail-value">{{item.timeSlot}}</text>
          </view>
          <view class="detail-row">
            <text class="detail-label">æ—¶é•¿ï¼š</text>
            <text class="detail-value">{{item.duration}}å°æ—¶</text>
          </view>
          <view class="detail-row">
            <text class="detail-label">è´¹ç”¨ï¼š</text>
            <text class="detail-value price">Â¥{{item.finalPrice || item.totalPrice}}</text>
          </view>
        </view>
      </view>
      
      <view class="card-actions">
        <!-- å·²ç¡®è®¤çŠ¶æ€çš„æ“ä½œ -->
        <block wx:if="{{item.status === 'confirmed' || item.status === 'paid'}}">
          <button 
            class="action-btn btn-secondary" 
            bindtap="cancelBooking"
            data-id="{{item.id}}"
          >
            å–æ¶ˆé¢„çº¦
          </button>
          <button 
            class="action-btn btn-primary" 
            bindtap="viewDetails"
            data-booking="{{item}}"
          >
            æŸ¥çœ‹è¯¦æƒ…
          </button>
        </block>
        
        <!-- å·²å®ŒæˆçŠ¶æ€çš„æ“ä½œ -->
        <block wx:if="{{item.status === 'completed'}}">
          <button 
            class="action-btn btn-secondary" 
            bindtap="rateBooking"
            data-id="{{item.id}}"
          >
            è¯„ä»·
          </button>
          <button 
            class="action-btn btn-primary" 
            bindtap="rebookSame"
            data-booking="{{item}}"
          >
            å†æ¬¡é¢„çº¦
          </button>
        </block>
        
        <!-- å·²å–æ¶ˆçŠ¶æ€çš„æ“ä½œ -->
        <block wx:if="{{item.status === 'cancelled'}}">
          <button 
            class="action-btn btn-primary" 
            bindtap="rebookSame"
            data-booking="{{item}}"
          >
            é‡æ–°é¢„çº¦
          </button>
        </block>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{filteredBookings.length === 0}}">
    <view class="empty-icon">ğŸ“‹</view>
    <text class="empty-text">æš‚æ— {{getTabText(activeTab)}}è®°å½•</text>
    <button 
      class="empty-btn btn-primary" 
      bindtap="goToBooking"
    >
      ç«‹å³é¢„çº¦
    </button>
  </view>
</view>

<!-- é¢„çº¦è¯¦æƒ…å¼¹çª— -->
<view class="detail-modal" wx:if="{{showDetailModal}}" bindtap="closeDetailModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">é¢„çº¦è¯¦æƒ…</text>
      <text class="modal-close" bindtap="closeDetailModal">Ã—</text>
    </view>
    
    <view class="detail-content" wx:if="{{selectedBooking}}">
      <view class="detail-section">
        <text class="section-title">åœºåœ°ä¿¡æ¯</text>
        <view class="info-item">
          <text class="info-label">åœºåœ°åç§°ï¼š</text>
          <text class="info-value">{{selectedBooking.courtName}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">åœºåœ°ç±»å‹ï¼š</text>
          <text class="info-value">æ ‡å‡†åœºåœ°</text>
        </view>
      </view>
      
      <view class="detail-section">
        <text class="section-title">é¢„çº¦ä¿¡æ¯</text>
        <view class="info-item">
          <text class="info-label">é¢„çº¦æ—¥æœŸï¼š</text>
          <text class="info-value">{{formatDate(selectedBooking.date)}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">ä½¿ç”¨æ—¶é—´ï¼š</text>
          <text class="info-value">{{selectedBooking.timeSlot}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">ä½¿ç”¨æ—¶é•¿ï¼š</text>
          <text class="info-value">{{selectedBooking.duration}}å°æ—¶</text>
        </view>
      </view>
      
      <view class="detail-section">
        <text class="section-title">è´¹ç”¨ä¿¡æ¯</text>
        <view class="info-item">
          <text class="info-label">åœºåœ°è´¹ç”¨ï¼š</text>
          <text class="info-value">Â¥{{selectedBooking.totalPrice}}</text>
        </view>
        <view class="info-item" wx:if="{{selectedBooking.coupon}}">
          <text class="info-label">ä¼˜æƒ åˆ¸ï¼š</text>
          <text class="info-value discount">-Â¥{{selectedBooking.coupon.discount}}</text>
        </view>
        <view class="info-item total">
          <text class="info-label">å®ä»˜é‡‘é¢ï¼š</text>
          <text class="info-value price">Â¥{{selectedBooking.finalPrice || selectedBooking.totalPrice}}</text>
        </view>
      </view>
      
      <view class="detail-section">
        <text class="section-title">è”ç³»ä¿¡æ¯</text>
        <view class="info-item">
          <text class="info-label">è”ç³»äººï¼š</text>
          <text class="info-value">{{selectedBooking.userInfo.name}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">æ‰‹æœºå·ï¼š</text>
          <text class="info-value">{{selectedBooking.userInfo.phone}}</text>
        </view>
        <view class="info-item" wx:if="{{selectedBooking.userInfo.remark}}">
          <text class="info-label">å¤‡æ³¨ï¼š</text>
          <text class="info-value">{{selectedBooking.userInfo.remark}}</text>
        </view>
      </view>
      
      <view class="detail-section">
        <text class="section-title">è®¢å•ä¿¡æ¯</text>
        <view class="info-item">
          <text class="info-label">è®¢å•å·ï¼š</text>
          <text class="info-value">{{selectedBooking.id}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">åˆ›å»ºæ—¶é—´ï¼š</text>
          <text class="info-value">{{formatTime(selectedBooking.createTime)}}</text>
        </view>
        <view class="info-item" wx:if="{{selectedBooking.paymentTime}}">
          <text class="info-label">æ”¯ä»˜æ—¶é—´ï¼š</text>
          <text class="info-value">{{formatTime(selectedBooking.paymentTime)}}</text>
        </view>
      </view>
    </view>
  </view>
</view>